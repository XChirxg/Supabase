<!DOCTYPE html>
<html>
<head>
  <title>Supabase Test</title>
</head>
<body>
  <h2>Supabase Basic Test</h2>

  <input id="msg" placeholder="Type a message" />
  <button onclick="sendMessage()">Send</button>

  <ul id="list"></ul>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "https://sybshyrctntyxiniynjv.supabase.co";
  const SUPABASE_KEY = "sb_publishable_yq2MyS0fW3CIVlccDh70Cg_TP7wxCCe";

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // ðŸ”” Ask notification permission once
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }

  // ðŸ” Anonymous login (only if not logged in)
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    await supabase.auth.signInAnonymously();
  }

  async function loadMessages() {
    const { data, error } = await supabase
      .from("messages")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Load error:", error);
      return;
    }

    const list = document.getElementById("list");
    list.innerHTML = "";

    data.forEach(m => {
      const li = document.createElement("li");
      li.textContent = m.text;
      list.appendChild(li);
    });
  }

  // âš¡ Call Edge Function
  async function notifyServer(messageText) {
    const { data: { session } } = await supabase.auth.getSession();

    const res = await fetch(
      `${SUPABASE_URL}/functions/v1/send-notification`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${session.access_token}`
        },
        body: JSON.stringify({ message: messageText })
      }
    );

    if (!res.ok) {
      console.error("Function error");
      return;
    }

    const data = await res.json();

    if (Notification.permission === "granted") {
      new Notification(data.title, { body: data.body });
    }
  }

  // âœ‰ï¸ Send message
  window.sendMessage = async () => {
    const input = document.getElementById("msg");
    const text = input.value.trim();

    if (!text) return;

    const { data: { user } } = await supabase.auth.getUser();

    const { error } = await supabase.from("messages").insert({
      text,
      user_id: user.id
    });

    if (error) {
      console.error("Insert error:", error);
      return;
    }

    await notifyServer(text);

    input.value = "";
    loadMessages();
  };

  loadMessages();
</script>
</body>
</html>
